#!/usr/bin/env ruby
require 'set'

def common_error_id(line)
  line = line.chomp
  line.gsub!(/\b[3-9]\.[0-9]+[-a-z0-9.]+/, '#') # linux version: 3.17.0-next-20141008-g099669ed
  line.gsub!(/\b[1-9][0-9]-[A-Z][a-z]+-[0-9]{4}\b/, '#') # Date: 28-Dec-2013
  line.gsub!(/\b0x[0-9a-f]+\b/, '#') # hex number
  line.gsub!(/\b[a-f0-9]{40}\b/, '#') # SHA-1
  line.gsub!(/\b[0-9][0-9.]*/, '#') # number
  line.gsub!(/#x\b/, '0x')
  line.gsub!(/[\\"$]/, '~')
  line.gsub!(/[ \t]/, ' ')
  line.gsub!(/\ \ +/, ' ')
  line.gsub!(/([^a-zA-Z0-9])\ /, '\1')
  line.gsub!(/\ ([^a-zA-Z])/, '\1')
  line.gsub!(/^\ /, '')
  line.gsub!(/^-/, '')
  line.gsub!(/\  _/, '_')
  line.tr!(' ', '-')
  line.gsub!(/[-_.,;:#!\[(]+$/, '')
  line.gsub!(/([-_.,;:#!]){3,}/, ':')
  line
end

error_ids = Set.new
in_stderr = 0
seqno = ''

while (line = STDIN.gets)
  case line.chomp!
  when /^## ______________([0-9.]+):stderr$/
    in_stderr = 1
    seqno = $1
    next
  when /^## ______________#{seqno}:enderr$/
    in_stderr = 0
    seqno = ''
  end
  next unless in_stderr
  next unless line.include?('error') || line.include?('warning')

  error_ids << common_error_id(line)
end

error_ids.each do |id|
  puts id + ': 1'
end
