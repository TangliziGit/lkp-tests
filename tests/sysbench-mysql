#!/bin/sh
# mysql_user
# mysql_host
# mysql_port
# mysql_db
# db_driver
# - oltp_test_mode
# - oltp_tables_count
# - oltp_table_size
# - nr_threads
# - runtime
# - report_interval

: "${mysql_user:=root}"
: "${mysql_host:=localhost}"
: "${mysql_port:=3306}"
: "${mysql_db:=test_1000}"
: "${db_driver:=mysql}"
: "${oltp_test_mode:=complex}"
: "${oltp_tables_count:=3}"
: "${oltp_table_size:=1000}"
: "${nr_threads:=64}"
: "${runtime:=120}"
: "${report_interval:=10}"

args=(
	 --mysql-user=$mysql_user
	 --mysql-host=$mysql_host
 	 --mysql-port=$mysql_port
 	 --mysql-db=$mysql_db
	 --db-driver=$db_driver
	 --oltp-test-mode=$oltp_test_mode
	 --oltp-tables-count=$oltp_tables_count
	 --oltp-table-size=$oltp_table_size
	 --threads=$nr_threads
	 --time=$runtime
	 --report-interval=$report_interval
)

run_sysbench_step()
{
	sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua "${args[@]}" $1
}

run_sysbench_mysql()
{
	systemctl start mysqld
	mysql -e "create database test_1000;"
	run_sysbench_step prepare
	run_sysbench_step run
	run_sysbench_step cleanup
}

run_sysbench_mysql
