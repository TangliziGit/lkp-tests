#!/bin/bash

. $LKP_SRC/lib/email.sh
. $LKP_SRC/lib/log.sh
. $LKP_SRC/lib/upload.sh

source /etc/profile.d/compass.sh

submit_args=(
		"testbox=dc-8g cci-depends.benchmark=sshd cci-depends.yaml"
		"testbox=dc-8g borrow-1h.yaml runtime=1m"
		"testbox=vm-2p8g borrow-1h.yaml runtime=1m"
	    )

submit_job()
{
	for args in "${submit_args[@]}"
	do
		submit -m $args group_id=selftest
	done

	report_content=$(es-jobs group_id=selftest | grep job_state)
	log_info "selftest job result: $report_content"
}

get_commit_info()
{
	cd /c/compass-ci || exit

	commit_id=$(git log -1 --format="%H")
	commit_subject=$(git log -1 --format="%s")

	author_name=$(git log -1 --format="%an")
	author_email=$(git log -1 --format="%ae")

	committer=$(git log -1 --format="%cn")
	committer_email=$(git log -1 --format="%ce")

	recipient_email="$author_email;$committer_email"

}

upload_failed_result()
{
	lab=$(awk '/^lab:\s/ {print $2; exit}' /etc/compass-ci/defaults/*.yaml)
	job_ids=$(find /srv/result -name "$lab.*"| awk -F'/' '{print $NF}')
	for job_id in $job_ids
	do
		result_root=/srv$(es-find id=$job_id | grep result_root | cut -d'"' -f4)
		es-find id=$job_id| grep job_state| grep -q finished || upload_files -t $job_id $result_root/*
	done
}

get_commit_info
submit_job
send_email selftest
upload_failed_result
